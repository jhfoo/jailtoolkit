parseOptions() {
    while [ -n "$1" ]
    do
        case $1 in
            -noconsul)
                echo "Disabling Consul install"
                NOCONSUL=1
                shift
                ;;
            -j)
                shift
                JAIL_NAME=$1
                echo "Jail name: ${JAIL_NAME}"
                shift
                ;;
            -s)
                shift
                JAIL_SERVICE=$1
                echo "Installing service ${JAIL_SERVICE}"
                shift
                ;;
            -b)
                shift
                IF_BRIDGE=$1
                echo "Defining main bridge ${IF_BRIDGE}"
                shift
                ;;
            -noif)
                shift
                IF_HOST=$1
                echo "Removing interface ${IF_HOST} from bridge"
                shift
                ;;
            *)
                echo "ERROR: Unrecognized param $1"
                exit 1
        esac
    done
}

validateArgs() {
    if [ -z $JAIL_NAME ]
    then
        echo "ERROR: Missing jail name. Define with -j"
        exit 1
    fi

    if [ -n $IF_HOST ] && [ -z $IF_BRIDGE ]
    then
        echo "ERROR: To remove interface ${IF_HOST} bridge must be defined with -b"
        exit 1
    fi
}

createJail() {
    echo "Creating jail ${JAIL_NAME}"
    SIOCAGE="sudo iocage"
    $SIOCAGE create -r ${JAIL_RELEASE} -n ${JAIL_NAME}
    $SIOCAGE set bpf=1 $JAIL_NAME
    $SIOCAGE set vnet=1 $JAIL_NAME
    $SIOCAGE set dhcp=1 $JAIL_NAME

    if [ -n "${IF_HOST}" ]
    then 
        echo "Removing ${IF_HOST} from bridge ${IF_BRIDGE}"
        sudo ifconfig $IF_BRIDGE deletem $IF_HOST
    fi

    echo "Starting jail ${JAIL_NAME}"
    $SIOCAGE start $JAIL_NAME

    # install pkgs
    $SIOCAGE exec $JAIL_NAME "pkg install -y ${INSTALL_PACKAGES}"

    # create app account
    $SIOCAGE exec $JAIL_NAME "echo ${APP_PWD} | pw useradd ${APP_ID} -h 0 -m -s /usr/local/bin/zsh"
    $SIOCAGE exec $JAIL_NAME "touch /home/${APP_ID}/.zshrc"

}
